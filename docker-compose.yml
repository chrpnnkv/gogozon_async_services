services:
  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    healthcheck:
      test: [ "CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 >/dev/null 2>&1" ]
      interval: 5s
      timeout: 5s
      retries: 20

  kafka-setup:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      kafka:
        condition: service_healthy
    command: |
      bash -c 'kafka-topics --create --if-not-exists --topic orders.payment.requested --bootstrap-server kafka:9092 --replication-factor 1 --partitions 1 && \
              kafka-topics --create --if-not-exists --topic payments.payment.result --bootstrap-server kafka:9092 --replication-factor 1 --partitions 1 && \
              kafka-topics --create --if-not-exists --topic orders.payment.requested.retry --bootstrap-server kafka:9092 --replication-factor 1 --partitions 1 && \
              kafka-topics --create --if-not-exists --topic orders.payment.requested.dlq --bootstrap-server kafka:9092 --replication-factor 1 --partitions 1'
    restart: "no"

  orders-postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: orders
      POSTGRES_PASSWORD: orders
      POSTGRES_DB: orders
    ports:
      - "5433:5432"
    volumes:
      - orders_pg_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U orders -d orders -h localhost" ]
      interval: 5s
      timeout: 5s
      retries: 20

  payments-postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: payments
      POSTGRES_PASSWORD: payments
      POSTGRES_DB: payments
    ports:
      - "5434:5432"
    volumes:
      - payments_pg_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U payments -d payments -h localhost" ]
      interval: 5s
      timeout: 5s
      retries: 20

  orders-migrate:
    image: migrate/migrate:v4.17.1
    depends_on:
      orders-postgres:
        condition: service_healthy
    volumes:
      - ./migrations/orders:/migrations:ro
    entrypoint:
      - migrate
      - -path
      - /migrations
      - -database
      - postgres://orders:orders@orders-postgres:5432/orders?sslmode=disable
    command: [ "up" ]
    restart: "no"

  payments-migrate:
    image: migrate/migrate:v4.17.1
    depends_on:
      payments-postgres:
        condition: service_healthy
    volumes:
      - ./migrations/payments:/migrations:ro
    entrypoint:
      - migrate
      - -path
      - /migrations
      - -database
      - postgres://payments:payments@payments-postgres:5432/payments?sslmode=disable
    command: [ "up" ]
    restart: "no"

  orders:
    build:
      context: .
      dockerfile: ./cmd/orders/Dockerfile
    environment:
      - ORDERS_DB_DSN=postgres://orders:orders@orders-postgres:5432/orders?sslmode=disable
      - KAFKA_BROKERS=kafka:9092
      - KAFKA_TOPIC_PAYMENT_REQUESTED=orders.payment.requested
      - KAFKA_TOPIC_PAYMENT_RESULT=payments.payment.result
      - ORDERS_CONSUMER_GROUP=orders-service-debug
    depends_on:
      kafka:
        condition: service_healthy
      kafka-setup:
        condition: service_completed_successfully
      orders-postgres:
        condition: service_healthy
      orders-migrate:
        condition: service_completed_successfully
    ports:
      - "8081:8080"
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/health >/dev/null 2>&1" ]
      interval: 5s
      timeout: 3s
      retries: 20

  payments:
    build:
      context: .
      dockerfile: ./cmd/payments/Dockerfile
    environment:
      - PAYMENTS_DB_DSN=postgres://payments:payments@payments-postgres:5432/payments?sslmode=disable
      - KAFKA_BROKERS=kafka:9092
      - KAFKA_TOPIC_PAYMENT_REQUESTED=orders.payment.requested
      - KAFKA_TOPIC_PAYMENT_RESULT=payments.payment.result
      - PAYMENTS_CONSUMER_GROUP=payments-service
      - KAFKA_RETRY_MAX=3
      - KAFKA_RETRY_TOPIC=orders.payment.requested.retry
      - KAFKA_DLQ_TOPIC=orders.payment.requested.dlq
    depends_on:
      kafka:
        condition: service_healthy
      kafka-setup:
        condition: service_completed_successfully
      payments-postgres:
        condition: service_healthy
      payments-migrate:
        condition: service_completed_successfully
    ports:
      - "8082:8080"
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/health >/dev/null 2>&1" ]
      interval: 5s
      timeout: 3s
      retries: 20

  gateway:
    build:
      context: .
      dockerfile: ./cmd/gateway/Dockerfile
    environment:
      - ORDERS_BASE_URL=http://orders:8080
      - PAYMENTS_BASE_URL=http://payments:8080
    depends_on:
      orders:
        condition: service_healthy
      payments:
        condition: service_healthy
    ports:
      - "8080:8080"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    depends_on:
      - gateway
    ports:
      - "8083:8080"

volumes:
  orders_pg_data:
  payments_pg_data:
